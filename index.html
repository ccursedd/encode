<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kittybin.org</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #0a0a0a;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, monospace;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #000000;
            border: 2px solid #333333;
            padding: 20px 25px;
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #333333;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 40px;
            width: 100%;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ffffff;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .nav-links a {
            text-decoration: none;
            color: #cccccc;
            font-weight: 500;
            font-size: 1rem;
            padding: 5px 0;
            cursor: pointer;
        }

        .nav-links a.active {
            color: #ffffff;
            font-weight: 700;
            text-decoration: underline;
        }

        .nav-links a:hover {
            color: #ffffff;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-profile-mini {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 5px 15px;
            border: 1px solid #333;
            border-radius: 30px;
        }

        .user-profile-mini:hover {
            background: #1a1a1a;
        }

        .mini-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #444;
        }

        .username-display {
            color: #00ff00;
            font-weight: 600;
        }

        .logout-btn {
            background: #1a1a1a;
            color: #ff6666;
            border: 2px solid #444;
            padding: 5px 15px;
            cursor: pointer;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #222;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #333333;
            background: #111111;
            font-size: 1rem;
            color: #ffffff;
        }

        .search-input:focus {
            outline: none;
            border-color: #666666;
        }

        .pastes-header {
            font-size: 1rem;
            margin-bottom: 20px;
            color: #aaaaaa;
            border-left: 4px solid #444;
            padding-left: 10px;
        }

        .section-card {
            border: 2px solid #333333;
            margin-bottom: 30px;
            background: #0a0a0a;
        }

        .section-header {
            background: #1a1a1a;
            color: #ffffff;
            padding: 10px 15px;
            font-weight: 700;
            font-size: 1rem;
            border-bottom: 2px solid #333333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .paste-table, .user-table {
            width: 100%;
            border-collapse: collapse;
        }

        .paste-table th, .user-table th {
            text-align: left;
            padding: 15px 10px 8px 10px;
            font-weight: 600;
            font-size: 0.85rem;
            border-bottom: 2px solid #333333;
            color: #aaaaaa;
        }

        .paste-table td, .user-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #222222;
            font-size: 0.9rem;
            color: #dddddd;
        }

        .views {
            background: #1a1a1a;
            padding: 3px 10px;
            border: 1px solid #333;
            color: #ffffff;
        }

        .user-badge {
            color: #888888;
            margin-left: 5px;
            font-style: italic;
        }

        .create-paste {
            border: 2px solid #333333;
            padding: 25px;
            margin-bottom: 30px;
            background: #0a0a0a;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #cccccc;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #333333;
            background: #111111;
            color: #ffffff;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 200px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #666666;
        }

        .create-btn {
            background: #00aa00;
            color: white;
            border: 2px solid #00ff00;
            padding: 12px 30px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .create-btn:hover {
            background: #00cc00;
        }

        .cancel-btn {
            background: #333;
            color: white;
            border: 2px solid #666;
            padding: 12px 30px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            margin-left: 10px;
        }

        .cancel-btn:hover {
            background: #444;
        }

        .auth-container {
            display: flex;
            justify-content: center;
            margin: 40px 0;
        }

        .auth-box {
            width: 500px;
            border: 2px solid #333333;
            background: #0a0a0a;
        }

        .auth-header {
            background: #1a1a1a;
            color: #ffffff;
            padding: 15px 20px;
            font-weight: 700;
            font-size: 1.3rem;
            border-bottom: 2px solid #333333;
        }

        .auth-form {
            padding: 25px;
        }

        .auth-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #333333;
            background: #111111;
            color: #ffffff;
            margin-top: 5px;
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background: #1a1a1a;
            color: #ffffff;
            border: 2px solid #444444;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
        }

        .auth-btn:hover {
            background: #222222;
        }

        .auth-switch {
            margin-top: 20px;
            text-align: center;
            color: #888;
        }

        .auth-switch a {
            color: #ffffff;
            font-weight: 700;
            cursor: pointer;
            margin-left: 5px;
        }

        .error-message {
            color: #ff6666;
            margin-top: 10px;
            text-align: center;
        }

        .success-message {
            color: #00ff00;
            margin-top: 10px;
            text-align: center;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .no-data {
            padding: 30px;
            text-align: center;
            color: #666;
            border: 2px dashed #333;
        }

        .profile-header {
            position: relative;
            margin-bottom: 30px;
            border: 2px solid #333;
        }

        .profile-banner {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #1a1a1a;
            border-bottom: 2px solid #333;
            cursor: pointer;
        }

        .profile-banner:hover {
            opacity: 0.8;
        }

        .profile-avatar-container {
            position: relative;
            margin-top: -75px;
            margin-left: 30px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid #000;
            object-fit: cover;
            background: #1a1a1a;
            cursor: pointer;
        }

        .profile-avatar:hover {
            opacity: 0.8;
        }

        .profile-info {
            padding: 20px 30px;
        }

        .profile-username {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
        }

        .profile-role {
            color: #888;
            margin-bottom: 15px;
        }

        .profile-bio {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .profile-meta {
            display: flex;
            gap: 30px;
            color: #888;
            font-size: 0.9rem;
            margin-top: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-hint {
            color: #666;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .loading i {
            margin-right: 10px;
        }

        .user-with-avatar {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            object-fit: cover;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="top-bar">
        <div class="logo-area">
            <div class="logo">kittybin.org</div>
            <div class="nav-links">
                <a onclick="showPage('index')" id="nav-index" class="active">Add Paste</a>
                <a onclick="showPage('users')" id="nav-users">Users</a>
                <a onclick="showPage('profile')" id="nav-profile" style="display: none;">Profile</a>
                <a onclick="showPage('login')" id="nav-login">Login</a>
                <a onclick="showPage('signup')" id="nav-signup">Sign Up</a>
            </div>
        </div>
        <div class="user-status" id="userStatus" style="display: none;">
            <div class="user-profile-mini" onclick="showPage('profile')">
                <img id="miniAvatar" src="https://via.placeholder.com/30" alt="avatar" class="mini-avatar">
                <span class="username-display" id="currentUsername"></span>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="search-section">
        <input type="text" placeholder="Search pastes..." class="search-input" id="global-search" oninput="filterPastes()">
    </div>
    
    <!-- INDEX PAGE -->
    <div id="page-index" class="page active">
        <div class="section-header">
            <span>Create New Paste</span>
            <span id="pasteCount">0 total pastes</span>
        </div>
        
        <div class="create-paste" id="createPasteSection" style="display: none;">
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="pasteTitle" placeholder="Enter paste title" maxlength="100">
            </div>
            <div class="form-group">
                <label>Content</label>
                <textarea id="pasteContent" placeholder="Enter your paste content here..."></textarea>
            </div>
            <div>
                <button class="create-btn" onclick="createPaste()"><i class="fas fa-save"></i> Save Paste</button>
                <button class="cancel-btn" onclick="clearPasteForm()">Clear</button>
            </div>
        </div>
        <div id="loginPrompt" style="text-align: center; padding: 30px; border: 2px solid #333; margin-bottom: 30px; display: none;">
            <p>Please <a onclick="showPage('login')" style="color: #00ff00; cursor: pointer;">login</a> to create pastes</p>
        </div>

        <div class="section-header">Recent Pastes</div>
        <div class="section-card" id="pastesContainer">
            <table class="paste-table" id="pastesTable">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Views</th>
                        <th>Created by</th>
                        <th>Added</th>
                    </tr>
                </thead>
                <tbody id="pastesTableBody">
                    <tr>
                        <td colspan="4" class="no-data"><i class="fas fa-spinner fa-spin"></i> Loading pastes...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- USERS PAGE -->
    <div id="page-users" class="page">
        <div class="pastes-header">
            <i class="fas fa-users"></i> Registered Users
        </div>

        <div class="section-card">
            <table class="user-table" id="usersTable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Role</th>
                        <th>Pastes</th>
                        <th>Joined</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="4" class="no-data"><i class="fas fa-spinner fa-spin"></i> Loading users...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- PROFILE PAGE -->
    <div id="page-profile" class="page">
        <div class="profile-header">
            <img id="profileBanner" src="https://via.placeholder.com/1200x200/1a1a1a/666?text=Click+to+upload+banner" alt="banner" class="profile-banner" onclick="document.getElementById('bannerInput').click()">
            <input type="file" id="bannerInput" class="file-input" accept="image/*" onchange="uploadBanner(event)">
            <div class="upload-hint" style="text-align: center; margin-top: 5px;">Click banner to upload</div>
            
            <div class="profile-avatar-container">
                <img id="profileAvatar" src="https://via.placeholder.com/150" alt="avatar" class="profile-avatar" onclick="document.getElementById('avatarInput').click()">
                <input type="file" id="avatarInput" class="file-input" accept="image/*" onchange="uploadAvatar(event)">
                <div class="upload-hint">Click avatar to upload</div>
            </div>
            
            <div class="profile-info">
                <div class="profile-username" id="profileUsername"></div>
                <div class="profile-role" id="profileRole"></div>
                
                <div class="form-group">
                    <label>Bio</label>
                    <textarea id="bioInput" placeholder="Tell us about yourself..." rows="3"></textarea>
                    <button class="create-btn" style="margin-top: 10px;" onclick="updateBio()">Update Bio</button>
                </div>
                
                <div class="profile-meta">
                    <span><i class="fas fa-calendar"></i> Joined: <span id="profileJoined"></span></span>
                    <span><i class="fas fa-paste"></i> Pastes: <span id="profilePasteCount">0</span></span>
                </div>
            </div>
        </div>

        <div class="section-header">My Pastes</div>
        <div class="section-card">
            <table class="paste-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Views</th>
                        <th>Added</th>
                    </tr>
                </thead>
                <tbody id="profilePastesBody">
                    <tr>
                        <td colspan="3" class="no-data">No pastes yet</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- LOGIN PAGE -->
    <div id="page-login" class="page">
        <div class="auth-container">
            <div class="auth-box">
                <div class="auth-header">Login</div>
                <div class="auth-form">
                    <div class="form-group">
                        <label>Username or Email</label>
                        <input type="text" id="loginUsername" class="auth-input">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" class="auth-input">
                    </div>
                    <button class="auth-btn" onclick="login()">Login</button>
                    <div class="auth-switch">
                        Don't have an account? <a onclick="showPage('signup')">Sign Up</a>
                    </div>
                    <div id="loginError" class="error-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SIGNUP PAGE -->
    <div id="page-signup" class="page">
        <div class="auth-container">
            <div class="auth-box">
                <div class="auth-header">Sign Up</div>
                <div class="auth-form">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="signupUsername" class="auth-input">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="signupEmail" class="auth-input">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signupPassword" class="auth-input">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" class="auth-input">
                    </div>
                    <button class="auth-btn" onclick="signup()">Create Account</button>
                    <div class="auth-switch">
                        Already have an account? <a onclick="showPage('login')">Login</a>
                    </div>
                    <div id="signupError" class="error-message"></div>
                    <div id="signupSuccess" class="success-message"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ========== SUPABASE CONFIGURATION ==========
    const supabaseUrl = 'https://ylgtgecqhdhakzbjdkqq.supabase.co';
    const supabaseAnonKey = 'sb_publishable_ILF6pER_bdL8GppxOzfumg_xsDoMA6T';
    
    const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

    // ========== GLOBAL VARIABLES ==========
    let currentUser = null;

    // ========== CHECK SESSION ON LOAD ==========
    async function checkSession() {
        try {
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error) throw error;
            
            if (session) {
                // Get user data from users table
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();
                    
                if (userError) throw userError;
                
                currentUser = userData;
                updateUserStatus();
                await loadUserData();
                showPage('index');
            }
        } catch (error) {
            console.error('Session check failed:', error);
            await supabase.auth.signOut();
        }
    }

    // ========== AUTH FUNCTIONS ==========
    async function login() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');

        errorDiv.textContent = '';

        if (!username || !password) {
            errorDiv.textContent = 'Username/email and password are required';
            return;
        }

        try {
            let email = username;
            // If username doesn't contain @, try to find user by username first
            if (!username.includes('@')) {
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('email')
                    .eq('username', username)
                    .single();
                    
                if (userError) {
                    errorDiv.textContent = 'Invalid username or password';
                    return;
                }
                email = userData.email;
            }

            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) throw error;

            // Get user data
            const { data: userData, error: userError } = await supabase
                .from('users')
                .select('*')
                .eq('id', data.user.id)
                .single();

            if (userError) throw userError;

            currentUser = userData;
            errorDiv.textContent = '';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            
            await loadUserData();
            updateUserStatus();
            showPage('index');
        } catch (error) {
            console.error('Login error:', error);
            errorDiv.textContent = 'Invalid username or password';
        }
    }

    async function signup() {
        const username = document.getElementById('signupUsername').value.trim();
        const email = document.getElementById('signupEmail').value.trim();
        const password = document.getElementById('signupPassword').value;
        const confirmPassword = document.getElementById('signupConfirmPassword').value;
        const errorDiv = document.getElementById('signupError');
        const successDiv = document.getElementById('signupSuccess');

        errorDiv.textContent = '';
        successDiv.textContent = '';

        if (!username || !email || !password) {
            errorDiv.textContent = 'All fields are required';
            return;
        }

        if (!email.includes('@')) {
            errorDiv.textContent = 'Invalid email address';
            return;
        }

        if (password.length < 6) {
            errorDiv.textContent = 'Password must be at least 6 characters';
            return;
        }

        if (password !== confirmPassword) {
            errorDiv.textContent = 'Passwords do not match';
            return;
        }

        try {
            // Check if username exists
            const { data: existingUser, error: checkError } = await supabase
                .from('users')
                .select('username')
                .eq('username', username)
                .single();

            if (existingUser) {
                errorDiv.textContent = 'Username already exists';
                return;
            }

            // Create auth user
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email: email,
                password: password
            });

            if (authError) throw authError;

            // Create user profile
            const { error: profileError } = await supabase
                .from('users')
                .insert({
                    id: authData.user.id,
                    username: username,
                    email: email,
                    role: 'User',
                    created_at: new Date().toISOString()
                });

            if (profileError) throw profileError;

            successDiv.textContent = 'Account created successfully! You can now login.';
            
            // Clear form
            document.getElementById('signupUsername').value = '';
            document.getElementById('signupEmail').value = '';
            document.getElementById('signupPassword').value = '';
            document.getElementById('signupConfirmPassword').value = '';
        } catch (error) {
            console.error('Signup error:', error);
            errorDiv.textContent = error.message || 'Signup failed. Please try again.';
        }
    }

    async function logout() {
        await supabase.auth.signOut();
        currentUser = null;
        updateUserStatus();
        showPage('index');
        await loadPastes();
    }

    // ========== PROFILE FUNCTIONS ==========
    async function uploadAvatar(event) {
        if (!currentUser) return;
        
        const file = event.target.files[0];
        if (!file) return;

        try {
            const fileExt = file.name.split('.').pop();
            const fileName = `${currentUser.id}/avatar.${fileExt}`;
            
            const { error: uploadError } = await supabase.storage
                .from('avatars')
                .upload(fileName, file, { upsert: true });

            if (uploadError) throw uploadError;

            const { data: { publicUrl } } = supabase.storage
                .from('avatars')
                .getPublicUrl(fileName);

            // Update user profile
            const { error: updateError } = await supabase
                .from('users')
                .update({ avatar_url: publicUrl })
                .eq('id', currentUser.id);

            if (updateError) throw updateError;

            currentUser.avatar_url = publicUrl;
            document.getElementById('profileAvatar').src = publicUrl;
            document.getElementById('miniAvatar').src = publicUrl;
            
            await loadUsers(); // Refresh users list
        } catch (error) {
            console.error('Avatar upload failed:', error);
            alert('Failed to upload avatar');
        }
    }

    async function uploadBanner(event) {
        if (!currentUser) return;
        
        const file = event.target.files[0];
        if (!file) return;

        try {
            const fileExt = file.name.split('.').pop();
            const fileName = `${currentUser.id}/banner.${fileExt}`;
            
            const { error: uploadError } = await supabase.storage
                .from('banners')
                .upload(fileName, file, { upsert: true });

            if (uploadError) throw uploadError;

            const { data: { publicUrl } } = supabase.storage
                .from('banners')
                .getPublicUrl(fileName);

            // Update user profile
            const { error: updateError } = await supabase
                .from('users')
                .update({ banner_url: publicUrl })
                .eq('id', currentUser.id);

            if (updateError) throw updateError;

            currentUser.banner_url = publicUrl;
            document.getElementById('profileBanner').src = publicUrl;
        } catch (error) {
            console.error('Banner upload failed:', error);
            alert('Failed to upload banner');
        }
    }

    async function updateBio() {
        if (!currentUser) return;

        const bio = document.getElementById('bioInput').value;
        
        try {
            const { error } = await supabase
                .from('users')
                .update({ bio: bio })
                .eq('id', currentUser.id);

            if (error) throw error;

            currentUser.bio = bio;
            document.getElementById('profileBio').textContent = bio || 'No bio yet';
            alert('Bio updated successfully!');
        } catch (error) {
            console.error('Bio update failed:', error);
            alert('Failed to update bio');
        }
    }

    // ========== PASTE FUNCTIONS ==========
    async function loadPastes() {
        const tbody = document.getElementById('pastesTableBody');
        const pasteCount = document.getElementById('pasteCount');

        try {
            const { data: pastes, error } = await supabase
                .from('pastes')
                .select('*, users(username, role, avatar_url)')
                .order('created_at', { ascending: false });

            if (error) throw error;

            if (!pastes || pastes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-data">No pastes yet. Be the first to create one!</td></tr>';
                pasteCount.textContent = '0 total pastes';
                return;
            }

            tbody.innerHTML = '';
            pastes.forEach(paste => {
                const row = document.createElement('tr');
                const date = new Date(paste.created_at).toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                
                row.innerHTML = `
                    <td>${escapeHtml(paste.title)}</td>
                    <td><span class="views">${paste.views || 0}</span></td>
                    <td>
                        <div class="user-with-avatar">
                            ${paste.users?.avatar_url ? `<img src="${paste.users.avatar_url}" class="table-avatar">` : ''}
                            ${escapeHtml(paste.username)} ${paste.users?.role !== 'User' ? `<span class="user-badge">[${escapeHtml(paste.users?.role)}]</span>` : ''}
                        </div>
                    </td>
                    <td>${date}</td>
                `;
                tbody.appendChild(row);
            });

            pasteCount.textContent = `${pastes.length} total pastes`;
        } catch (error) {
            console.error('Failed to load pastes:', error);
            tbody.innerHTML = '<tr><td colspan="4" class="no-data">Failed to load pastes</td></tr>';
        }
    }

    async function createPaste() {
        if (!currentUser) {
            alert('You must be logged in to create a paste');
            showPage('login');
            return;
        }

        const title = document.getElementById('pasteTitle').value.trim();
        const content = document.getElementById('pasteContent').value.trim();

        if (!title || !content) {
            alert('Title and content are required');
            return;
        }

        try {
            const { error } = await supabase
                .from('pastes')
                .insert({
                    title: title,
                    content: content,
                    user_id: currentUser.id,
                    username: currentUser.username,
                    user_role: currentUser.role,
                    created_at: new Date().toISOString()
                });

            if (error) throw error;

            clearPasteForm();
            await loadPastes();
            await loadUserData();
            alert('Paste created successfully!');
        } catch (error) {
            console.error('Failed to create paste:', error);
            alert('Failed to create paste');
        }
    }

    // ========== USER FUNCTIONS ==========
    async function loadUsers() {
        const tbody = document.getElementById('usersTableBody');

        try {
            const { data: users, error } = await supabase
                .from('users')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-data">No users registered yet</td></tr>';
                return;
            }

            // Get paste counts
            const { data: pastes, error: pasteError } = await supabase
                .from('pastes')
                .select('user_id');

            if (pasteError) throw pasteError;

            const pasteCounts = {};
            pastes.forEach(p => {
                pasteCounts[p.user_id] = (pasteCounts[p.user_id] || 0) + 1;
            });

            tbody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                const date = new Date(user.created_at).toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                
                row.innerHTML = `
                    <td>
                        <div class="user-with-avatar">
                            <img src="${user.avatar_url || 'https://via.placeholder.com/25'}" 
                                 class="table-avatar">
                            ${escapeHtml(user.username)}
                        </div>
                    </td>
                    <td>${user.role !== 'User' ? `<span class="user-badge">[${escapeHtml(user.role)}]</span>` : ''}</td>
                    <td>${pasteCounts[user.id] || 0}</td>
                    <td>${date}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Failed to load users:', error);
            tbody.innerHTML = '<tr><td colspan="4" class="no-data">Failed to load users</td></tr>';
        }
    }

    async function loadUserData() {
        if (!currentUser) return;

        try {
            document.getElementById('profileUsername').textContent = currentUser.username;
            document.getElementById('profileRole').textContent = currentUser.role || 'User';
            document.getElementById('profileBio').textContent = currentUser.bio || 'No bio yet';
            document.getElementById('bioInput').value = currentUser.bio || '';
            
            const date = new Date(currentUser.created_at).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
            document.getElementById('profileJoined').textContent = date;

            if (currentUser.avatar_url) {
                document.getElementById('profileAvatar').src = currentUser.avatar_url;
                document.getElementById('miniAvatar').src = currentUser.avatar_url;
            }
            
            if (currentUser.banner_url) {
                document.getElementById('profileBanner').src = currentUser.banner_url;
            }

            const { data: pastes, error } = await supabase
                .from('pastes')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) throw error;

            const profilePastesBody = document.getElementById('profilePastesBody');
            document.getElementById('profilePasteCount').textContent = pastes?.length || 0;

            if (!pastes || pastes.length === 0) {
                profilePastesBody.innerHTML = '<tr><td colspan="3" class="no-data">No pastes yet</td></tr>';
            } else {
                profilePastesBody.innerHTML = '';
                pastes.forEach(paste => {
                    const row = document.createElement('tr');
                    const pasteDate = new Date(paste.created_at).toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        year: 'numeric' 
                    });
                    
                    row.innerHTML = `
                        <td>${escapeHtml(paste.title)}</td>
                        <td><span class="views">${paste.views || 0}</span></td>
                        <td>${pasteDate}</td>
                    `;
                    profilePastesBody.appendChild(row);
                });
            }
        } catch (error) {
            console.error('Failed to load user data:', error);
        }
    }

    // ========== UI FUNCTIONS ==========
    function updateUserStatus() {
        const userStatus = document.getElementById('userStatus');
        const navProfile = document.getElementById('nav-profile');
        const navLogin = document.getElementById('nav-login');
        const navSignup = document.getElementById('nav-signup');
        const createPasteSection = document.getElementById('createPasteSection');
        const loginPrompt = document.getElementById('loginPrompt');
        
        if (currentUser) {
            userStatus.style.display = 'flex';
            navProfile.style.display = 'inline';
            navLogin.style.display = 'none';
            navSignup.style.display = 'none';
            createPasteSection.style.display = 'block';
            loginPrompt.style.display = 'none';
            
            document.getElementById('currentUsername').textContent = currentUser.username;
            if (currentUser.avatar_url) {
                document.getElementById('miniAvatar').src = currentUser.avatar_url;
            }
        } else {
            userStatus.style.display = 'none';
            navProfile.style.display = 'none';
            navLogin.style.display = 'inline';
            navSignup.style.display = 'inline';
            createPasteSection.style.display = 'none';
            loginPrompt.style.display = 'block';
        }
    }

    function filterPastes() {
        const searchTerm = document.getElementById('global-search').value.toLowerCase();
        const rows = document.querySelectorAll('#pastesTableBody tr');
        
        rows.forEach(row => {
            if (row.classList.contains('no-data')) return;
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) || searchTerm === '' ? '' : 'none';
        });
    }

    function clearPasteForm() {
        document.getElementById('pasteTitle').value = '';
        document.getElementById('pasteContent').value = '';
    }

    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ========== PAGE NAVIGATION ==========
    async function showPage(pageId) {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        
        document.getElementById(`page-${pageId}`).classList.add('active');
        
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.classList.remove('active');
        });
        document.getElementById(`nav-${pageId}`).classList.add('active');

        if (pageId === 'index') {
            await loadPastes();
        } else if (pageId === 'users') {
            await loadUsers();
        } else if (pageId === 'profile' && currentUser) {
            await loadUserData();
        } else if (pageId === 'profile' && !currentUser) {
            showPage('login');
            return;
        }

        document.getElementById('global-search').value = '';
    }

    // ========== INITIALIZATION ==========
    window.onload = async function() {
        await checkSession();
        await loadPastes();
        await loadUsers();
        showPage('index');
    };
</script>
</body>
</html>
